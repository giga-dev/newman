<link rel="import" href="shared-mixin.html">
<link rel="import" href="routes.html">
<link rel="import" href="../components/core-ajax/core-ajax.html">
<link rel="import" href="../components/paper-button/paper-button.html">
<link rel="import" href="../components/paper-dialog/paper-action-dialog.html">
<link rel="import" href="../components/paper-button/paper-button.html">
<link rel="import" href="../components/paper-dialog/paper-action-dialog.html">


<polymer-element name="future-job" attributes="url">
    <template>
        <link rel="stylesheet" href="../components/bootstrap/dist/css/bootstrap.css">
        <core-ajax auto url="{{url}}" handleAs="json" on-core-response="{{ajaxResponse}}" withCredentials="true"></core-ajax>
        <core-ajax id="postFutureJob" method="POST" handleAs="json" on-core-response="{{jobSubmitResponse}}" withCredentials="true"></core-ajax>

        <div class="content" flex>
            <form>
                <select class="input-lg form-control" id="suiteId">
                    <option value="">Select a Suite</option>
                    <template repeat="{{suite in allSuites}}">
                        <option value="{{suite.id}}">{{suite.name}}</option>
                    </template>
                </select>


                <select class="input-lg form-control" id="buildId" style="margin-top: 15px">
                    <option value="">Select a Build</option>
                    <template repeat="{{build in allBuilds}}">
                        <option value="{{build.id}}">{{build.name}} ({{build.branch}})</option>
                    </template>
                </select>
                <button type="button" class="btn btn-default" on-click="{{submitFutureJob}}" style="margin-top: 15px">Submit</button>
            </form>
        </div>
        <label id="status" class="success" style="margin-top: 15px"></label>

        <paper-action-dialog backdrop autoCloseDisabled  id="alertDialog" heading="Submitting new Job" transition="paper-dialog-transition-bottom" style="position: fixed; outline: none; display: none;">
            <p>{{messageTxt}}</p>
            <paper-button affirmative raised class="colored">OK</paper-button>
        </paper-action-dialog>

    </template>

    <script>
        Polymer({
            applyAuthorStyles: true,
            messageTxt : '',
            created: function() {
                this.allSuites =[];
                this.allBuilds =[];
            },
            ajaxResponse: function(event,resp){
                var response = resp.response;
                this.allSuites = response.suites;
                this.allBuilds = response.builds;
            },
            jobSubmitResponse: function(event,resp){

                console.info("got future job response:", event, resp);
                 this.$.status.innerHTML = JSON.stringify(resp.response);
            },
            submitFutureJob : function(){
                var suiteId = this.$.suiteId.value;
                var buildId = this.$.buildId.value;

                if( !suiteId && !buildId ){
                    this.messageTxt = 'Both invalid Suite and Build were selected';
                    //alert( 'Invalid Suite and Build were selected' );
                    this.$.alertDialog.toggle();
                }
                else if( !suiteId ){
                    this.messageTxt = 'Invalid Suite was selected';
                    //alert( 'Invalid Suite was selected' );
                    this.$.alertDialog.toggle();
                }
                else if( !buildId ){
                    this.messageTxt = 'Invalid Build was selected';
                    //alert( 'Invalid Build was selected' );
                    this.$.alertDialog.toggle();
                }
                if( suiteId && buildId){
                    this.$.postFutureJob.url = "api/newman/futureJob/" + buildId + "/" + suiteId;
                    this.$.postFutureJob.go();
                }
            },
        });
    </script>
</polymer-element>