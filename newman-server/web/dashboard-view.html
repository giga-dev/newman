<script src="../components/webcomponentsjs/webcomponents.js"></script>

<link rel="import" href="routes.html">
<link rel="import" href="newman-switch.html">
<link rel="import" href="../components/core-ajax/core-ajax.html">

<polymer-element name="dashboard-view" attributes="url active" on-created-build="{{onCreatedBuild}}"
                 on-modified-build="{{onModifiedBuild}}">
    <template>
        <link rel="stylesheet" href="../components/bootstrap/dist/css/bootstrap.css">
        <link rel="stylesheet" href="app.css">
        <style>
            .table-nowrap {
                table-layout:fixed;
            }

            .table-nowrap td {
                 white-space: nowrap;
                 overflow: hidden;
                 text-overflow: ellipsis;
            }
        </style>
        <core-ajax auto url="{{url}}" handleAs="json" on-core-response="{{ajaxResponse}}"
                   withCredentials="true"></core-ajax>
        <div class="content" flex>
            <div class="table-responsive">
                <h1>Active Builds</h1>
                <table class="table table-bordered table-striped table-hover table-nowrap">
                    <thead>
                    <tr>
                        <th width="18%">Name</th>
                        <th width="7%">Branch</th>
                        <th width="11%">Date</th>
                        <th width="23%"><span class="label label-success"># Passed</span> / <span class="label label-danger">Failed</span> / <span class="label label-primary">Pending</span><span class="label label-header">Tests</span></th>
                        <th width="15%"><span class="label label-success"># Done</span> / <span class="label label-default">Total</span><span class="label label-header">Jobs</span></th>
                        <th width="26%"><span class="label label-header">Suites</span></th>
                    </tr>
                    </thead>
                    <tbody>
                    <template repeat="{{activeBuild in data.activeBuilds}}">
                        <template if="{{activeBuild.buildStatus.totalJobs > 0}}">
                        <tr>
                            <td title="{{activeBuild.name}}"><a href="{{urlFor('build', {id: activeBuild.id})}}">{{activeBuild.name}}</a></td>
                            <td title="{{activeBuild.branch}}">{{activeBuild.branch}}</td>
                            <td>{{activeBuild.buildTime | formatDate}}</td>
                            <td>
                                <span class="label label-success">{{activeBuild.buildStatus.passedTests}}</span>
                                <span class="label label-danger">{{activeBuild.buildStatus.failedTests}}</span>
                                <span class="label label-primary">{{activeBuild.buildStatus.totalTests - activeBuild.buildStatus.passedTests - activeBuild.buildStatus.failedTests}}</span>
                            </td>

                            <td>
                                <span class="label label-success">{{activeBuild.buildStatus.doneJobs}}</span>
                                <span class="label label-default">{{activeBuild.buildStatus.totalJobs}}</span>
                            </td>
                            <td>
                                <template repeat="{{suiteId, index in activeBuild.buildStatus.suitesIds}}">
                                    <template if="{{index!== 'undefined' && activeBuild.buildStatus.suitesNames[index]}}">
                                        <a href="{{urlFor('suite', {id: suiteId})}}"><span class="label-link">{{calculateShortSuiteName(activeBuild.buildStatus.suitesNames[index])}}</span> </a>
                                    </template>
                                </template>
                            </td>
                        </tr>
                        </template>
                    </template>

                    </tbody>
                </table>
            </div>


            <div class="table-responsive">
                <h1>Pending Builds</h1>
                <table class="table table-bordered table-striped table-hover table-nowrap">
                    <thead>
                    <tr>
                        <th width="18%">Name</th>
                        <th width="7%">Branch</th>
                        <th width="11%">Date</th>
                        <th width="23%"><span class="label label-success"># Passed</span> / <span class="label label-danger">Failed</span> / <span class="label label-primary">Pending</span><span class="label label-header">Tests</span></th>
                        <th width="15%"><span class="label label-success"># Done</span> / <span class="label label-default">Total</span><span class="label label-header">Jobs</span></th>
                        <th width="26%"><span class="label label-header">Suites</span></th>
                    </tr>
                    </thead>
                    <tbody>
                    <template repeat="{{pendingBuild in data.pendingBuilds}}">
                        <template if="{{pendingBuild.buildStatus.totalJobs > 0}}">
                            <tr>
                                <td title="{{pendingBuild.name}}"><a href="{{urlFor('build', {id: pendingBuild.id})}}">{{pendingBuild.name}}</a></td>
                                <td title="{{pendingBuild.branch}}">{{pending.branch}}</td>
                                <td>{{pendingBuild.buildTime | formatDate}}</td>
                                <td>
                                    <span class="label label-success">{{pendingBuild.buildStatus.passedTests}}</span>
                                    <span class="label label-danger">{{pendingBuild.buildStatus.failedTests}}</span>
                                    <span class="label label-primary">{{pendingBuild.buildStatus.totalTests - pendingBuild.buildStatus.passedTests - pendingBuild.buildStatus.failedTests}}</span>
                                </td>

                                <td>
                                    <span class="label label-success">{{pendingBuild.buildStatus.doneJobs}}</span>
                                    <span class="label label-default">{{pendingBuild.buildStatus.totalJobs}}</span>
                                </td>
                                <td>
                                    <template repeat="{{suiteId, index in pendingBuild.buildStatus.suitesIds}}">
                                        <template if="{{index!== 'undefined' && pendingBuild.buildStatus.suitesNames[index]}}">
                                            <a href="{{urlFor('suite', {id: suiteId})}}"><span class="label-link">{{calculateShortSuiteName(pendingBuild.buildStatus.suitesNames[index])}}</span> </a>
                                        </template>
                                    </template>
                                </td>
                            </tr>
                        </template>
                    </template>

                    </tbody>
                </table>
            </div>

            <h1>History</h1>

            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover table-nowrap">
                    <thead>
                    <tr>
                        <th width="18%">Name</th>
                        <th width="7%">Branch</th>
                        <th width="11%">Date</th>
                        <th width="23%"><span class="label label-success"># Passed</span> / <span class="label label-danger">Failed</span> / <span class="label label-default">Total</span><span class="label label-header">Tests</span></th>
                        <th width="15%"><span class="label label-default">Total</span><span class="label label-header">Jobs</span></th>
                        <th width="26%"><span class="label label-header">Suites</span></th>
                    </tr>
                    </thead>
                    <tbody>
                    <template repeat="{{historyBuild in data.historyBuilds}}">
                        <template if="{{historyBuild.buildStatus.totalJobs > 0}}">
                            <tr class="{{{'succeed-row' : historyBuild.buildStatus.passedTests == historyBuild.buildStatus.totalTests, 'default-row' : historyBuild.buildStatus.passedTests != historyBuild.buildStatus.totalTests} | tokenList}}">
                                <td title="{{historyBuild.name}}"><a href="{{urlFor('build', {id: historyBuild.id})}}">{{historyBuild.name}}</a></td>
                                <td title="{{historyBuild.branch}}">{{historyBuild.branch}}</td>
                                <td>{{historyBuild.buildTime | formatDate}}</td>
                                <td>
                                    <span class="label label-success">{{historyBuild.buildStatus.passedTests}}</span>
                                    <span class="label label-danger">{{historyBuild.buildStatus.failedTests}}</span>
                                    <span class="label label-default">{{historyBuild.buildStatus.totalTests}}</span>
                                </td>

                                <td>{{historyBuild.buildStatus.totalJobs}}</td>
                                <td>
                                    <template repeat="{{suiteId, index in historyBuild.buildStatus.suitesIds}}">
                                        <template if="{{index!== 'undefined' && historyBuild.buildStatus.suitesNames[index]}}">
                                            <a href="{{urlFor('suite', {id: suiteId})}}"><span class="label-link">{{calculateShortSuiteName(historyBuild.buildStatus.suitesNames[index])}}</span></a>
                                        </template>
                                    </template>
                                </td>
                            </tr>
                        </template>
                    </template>

                    </tbody>
                </table>
            </div>
        </div>
    </template>
    <script src="../components/moment/moment.js"></script>

    <script>
    Polymer({
      applyAuthorStyles: true,

      created: function() {
          this.data = [];
          this.actives = {};
          this.history = {};
          this.active = false;
      },
      formatDate: function(date){
           return moment(new Date(date)).fromNow();
      },
      ajaxResponse: function(event,resp){
           this.data = resp.response;
           var actives = this.actives;
           this.data.activeBuilds.forEach(function(build){
                actives[build.id] = build;
           });
           var history = this.history;
           this.data.historyBuilds.forEach(function(build){
                history[build.id] = build;
           });
           console.info("dashboard ", this.data);
      },
      onCreatedBuild: function(ev, build){
            this.data.activeBuilds.unshift(build);
            this.actives[build.id] = build;
      },
      onModifiedBuild: function(ev, build){
            var found = this.actives[build.id];
            if(found){
                app.update(build, found);
                if(found.buildStatus.totalJobs === found.buildStatus.doneJobs){
                    delete this.actives[found.id];
                    var index = this.data.activeBuilds.indexOf(found);
                    if(-1 < index){
                        this.data.activeBuilds.splice(index, 1);
                    }
                    this.history[found.id] = found;
                    this.data.historyBuilds.unshift(found);
                    if(5 < this.data.historyBuilds.length){
                        this.data.historyBuilds.pop();
                    }
                }
            }else if(found = this.history[build.id]){
                app.update(build, found);
                if(found.buildStatus.doneJobs < found.buildStatus.totalJobs){
                    delete this.history[found.id];
                    var index = this.data.historyBuilds.indexOf(found);
                    if(-1 < index){
                        this.data.historyBuilds.splice(index, 1);
                    }
                    this.actives[found.id] = found;
                    this.data.activeBuilds.unshift(found);
                }
            }
      },
      activeChanged: function(oldValue, newValue){
           console.info("dashboard activeChanged to ", newValue);
      },
      calculateShortSuiteName: function( suiteName ) {
              return suiteName;
              /*var maxLength = 7;
                if (suiteName.length < maxLength) {
                    return suiteName;
                }
                return return suiteName.substring(0, maxLength);
              */
            }
    });


    </script>
</polymer-element>